<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
    "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>
Balls 3D
</title>
<script type="text/javascript" src="o3djs/base.js"></script>
<script type="text/javascript" src="balls3d/b3d.js"></script>
<script type="text/javascript" id="o3dscript">
o3djs.require('o3djs.util');
o3djs.require('o3djs.math')
o3djs.require('o3djs.rendergraph')
o3djs.require('o3djs.primitives')
o3djs.require('o3djs.material')

// global variables
var g_o3dElement
var g_client
var g_o3d
var g_math
var g_pack
var g_viewInfo=123
var g_eyePosition = [0, 0, 20]
var g_target = [0, 0, 19]
var g_camAngleY = 0

function debug(s, l) {
	if (l===undefined) l=0
	document.getElementById("dbg" + l).innerHTML = s + "<br>"
}

function debugh(s) {
	g_debug_http.open("POST", s, true)
	g_debug_http.send(null)		
}


// move camera in direction it's looking
function moveCamera(d) {
	var dx=Math.sin(g_camAngleY)
	var dz=Math.cos(g_camAngleY)
	g_eyePosition[0] -= dx*d
	g_eyePosition[2] -= dz*d
	setCamera()
}

// move camera in direction perpendicular to where it's looking
function slideCamera(d) {
	var dx=Math.sin(g_camAngleY+Math.PI*.5)
	var dz=Math.cos(g_camAngleY+Math.PI*.5)
	g_eyePosition[0] -= dx*d
	g_eyePosition[2] -= dz*d
	setCamera()
}

// pan camera about Y (up) axis
function turnCamera(d) {
	g_camAngleY += d
}

// compute camera target as offset from eye position given camera angle, and set view
function setCamera() {
	var dx=Math.sin(g_camAngleY)
	var dz=Math.cos(g_camAngleY)
	g_target = g_eyePosition.slice()
	g_target[0] -= dx
	g_target[2] -= dz
    g_viewInfo.drawContext.view = g_math.matrix4.lookAt(
            g_eyePosition,     // eye
            g_target,        // target
            [0, 1, 0])    // up
	debug("ang: " + g_camAngleY + " eye: " + g_eyePosition + " targ: " + g_target, 0)
}

// like it says
function keyPressedCallback(event) {
    event = event || window.event
    var keyChar = String.fromCharCode(o3djs.event.getEventKeyChar(event))
//    alert("  g_eyePosition: " + g_eyePosition)
//    alert("  g_viewInfo: " + g_viewInfo)
    var mat=g_viewInfo.drawContext.view
    switch(keyChar) {
    case '%':					//	left
    	turnCamera(0.05)
        break
    case "'":					// right
    	turnCamera(-0.05)
        break
    case '&':					// up (forward)
    case 'w':
    	moveCamera(0.4)
        break
    case '(':					// down (backward)
    case 's':
    	moveCamera(-0.5)
        break
    case 'a':					// up (forward)
    	slideCamera(0.5)
        break
    case 'd':					// down (backward)
    	slideCamera(-0.5)
        break
    case '!':					// page up
    	g_eyePosition[1] += 0.5
        break
    case '"':					// page down
    	g_eyePosition[1] -= 0.5
        break
    case '.':					// page down
		g_transformArray[0].rotateY(0.1)
		g_world.step()
		g_transformArray[1].identity()
		g_transformArray[1].translate(g_world.dynamics[0].pos)
		debug("cube:-->" + g_transformArray[0].getUpdatedWorldMatrix() + "<--",2)
		debug("sphere:-->" + g_transformArray[1].getUpdatedWorldMatrix() + "<--",3)
        break
    }
    setCamera()
//    debugh("key pressed-->" + keyChar + "<--")
	debug("key pressed-->" + keyChar + "<-- code: " + o3djs.event.getEventKeyChar(event) + " shift: "+event.shiftKey,1)
}

/**
 * Creates the client area.
 */
function initClient() {
    window.g_finished = false    // for selenium testing.
	g_debug_http = new XMLHttpRequest()

    // Runs the sample in V8. Comment out this line to run it in the browser
    // JavaScript engine, for example if you want to debug it.
    o3djs.util.setMainEngine(o3djs.util.Engine.V8)

//	console.log("initClient")
    o3djs.util.makeClients(main)
//    console.log("  after, g_viewInfo: " + g_viewInfo)
}


/**
 * Initializes global variables, positions camera, draws shapes.
 * @param {Array} clientElements Array of o3d object elements.
 */
function main(clientElements) {
    // Init global variables.
    initGlobals(clientElements)

    // Set up the view and projection transformations.
    initContext()

    // Add the shapes to the transform heirarchy.
    createShapes()
	g_world = new b3d.world(-10.0)
	g_world.addDBall(1, [0,3,0], [0,0,0,1])
	debug("g_world: " + g_world + " gravity: " + g_world.gravity,1)
	debug("dynamics[0].pos: " + g_world.dynamics[0],3)
}

/**
 * Initializes global variables and libraries.
 */
function initGlobals(clientElements) {
    g_o3dElement = clientElements[0]
    window.g_client = g_client = g_o3dElement.client
    g_o3d = g_o3dElement.o3d
    g_math = o3djs.math

    // Create a pack to manage the objects created.
    g_pack = g_client.createPack()

    // Create the render graph for a view.
    g_viewInfo = o3djs.rendergraph.createBasicView(
            g_pack,
            g_client.root,
            g_client.renderGraphRoot)
    window.document.onkeypress = keyPressedCallback
}

/**
 * Sets up reasonable view and projection matrices.
 */
function initContext() {
    // Set up a perspective transformation for the projection.
    g_viewInfo.drawContext.projection = g_math.matrix4.perspective(
            g_math.degToRad(30), // 30 degree frustum.
            g_o3dElement.clientWidth / g_o3dElement.clientHeight, // Aspect ratio.
            1,                                    // Near plane.
            5000)                            // Far plane.

    // Set up our view transformation to look towards the world origin where the
    // primitives are located.
    g_viewInfo.drawContext.view = g_math.matrix4.lookAt(
            g_eyePosition,     // eye
            g_target,        // target
            [0, 1, 0])    // up
}

/**
 * Creates a material based on the given single color.
 * @param {!o3djs.math.Vector4} baseColor A 4-component vector with
 *         the R,G,B, and A components of a color.
 * @return {!o3d.Material} A phong material whose overall pigment is
 *         baseColor.
 */
function createMaterial(baseColor) {
    // Create a new, empty Material object.
    return o3djs.material.createBasicMaterial(g_pack, g_viewInfo, baseColor)
}

/**
 * Creates shapes using the primitives utility library, and adds them to the
 * transform graph at the root node.
 */
function createShapes() {
    var cube = o3djs.primitives.createCube(
            g_pack,
            createMaterial([0,1,0,1]), // A green phong-shaded material.
            Math.sqrt(2))                                    // The length of each side of the cube.
	g_cube = cube
    var sphere = o3djs.primitives.createSphere(
            g_pack,
            createMaterial([1,0,0,1]),
            0.5,     // Radius of the sphere.
            30,        // Number of meridians.
            20)        // Number of parallels.
	g_sphere=sphere

    var plane = o3djs.primitives.createPlane(
            g_pack,
            createMaterial([0,1,1,1]),
            10,            // Width.
            10,    // Depth.
            1,            // Horizontal subdivisions.
            1)         // Vertical subdivisions.

    // Add the shapes to the transforms.
    var transformTable = [
        {shape: cube, translation: [-3, 1, 0]},
        {shape: sphere, translation: [0, 3, 0]},
        {shape: plane, translation: [0, -.5, 0]},
    ]

	g_transformArray=[0,0,0]
    for (var tt = 0; tt < transformTable.length; ++tt) {
        var transform = g_pack.createObject('Transform')
        transform.addShape(transformTable[tt].shape)
        transform.translate(transformTable[tt].translation)
        transform.parent = g_client.root;
		g_transformArray[tt]=transform
    }
}


</script>
</head>
<body onload="initClient()">
<h3>Balls 3D Physics Engine</h3>

Use arrow keys to navigate; pg up/dn; period
<br/>
<!-- Start of O3D plugin -->
<div id="o3d" style="width: 600px; height: 480px;"></div>
<div id="dbg0"></div>
<div id="dbg1"></div>
<div id="dbg2"></div>
<div id="dbg3"></div>
<div id="dbg4"></div>
<div id="dbg5"></div>
<div id="dbg6"></div>
<!-- End of O3D plugin -->
</body>
</html>

